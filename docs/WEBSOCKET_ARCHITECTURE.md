# WebSocket Support Architecture

## Fluxo de Dados

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Cliente (Browser/App)                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                  â”‚
                                  â”‚ WebSocket Upgrade Request
                                  â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         InteceptProxy (Port 8080)                    â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                    InterceptAddon                            â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  â€¢ websocket_start()   â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚   â”‚
â”‚  â”‚  â€¢ websocket_message() â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚                  â”‚   â”‚
â”‚  â”‚  â€¢ websocket_end()     â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚   â”‚                  â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚   â”‚   â”‚                       â”‚
â”‚                                     â–¼   â–¼   â–¼                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚                 WebSocketHistory                             â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  connections = {                                             â”‚   â”‚
â”‚  â”‚    flow_id: {                                                â”‚   â”‚
â”‚  â”‚      'id', 'url', 'host', 'status',                         â”‚   â”‚
â”‚  â”‚      'start_time', 'end_time', 'message_count'              â”‚   â”‚
â”‚  â”‚    }                                                         â”‚   â”‚
â”‚  â”‚  }                                                           â”‚   â”‚
â”‚  â”‚                                                               â”‚   â”‚
â”‚  â”‚  messages = {                                                â”‚   â”‚
â”‚  â”‚    flow_id: [                                                â”‚   â”‚
â”‚  â”‚      {                                                       â”‚   â”‚
â”‚  â”‚        'timestamp', 'from_client', 'content',               â”‚   â”‚
â”‚  â”‚        'is_binary', 'size'                                  â”‚   â”‚
â”‚  â”‚      }                                                       â”‚   â”‚
â”‚  â”‚    ]                                                         â”‚   â”‚
â”‚  â”‚  }                                                           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                     â”‚                                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                      â”‚
                                      â”‚ Passa para o servidor real
                                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Servidor WebSocket Real                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Interface GrÃ¡fica

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    InteceptProxy GUI                                 â”‚
â”‚                                                                       â”‚
â”‚  [Regras] [Intercept] [HistÃ³rico] ... [WebSocket ğŸ”Œ]                â”‚
â”‚  â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•   â”‚
â”‚                                                                       â”‚
â”‚  â”Œâ”€ ConexÃµes WebSocket â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ ID â”‚ Host         â”‚ URL                  â”‚ Status â”‚ Msg â”‚...â”‚  â”‚
â”‚  â”‚ 1  â”‚ example.com  â”‚ wss://example.com/ws â”‚ active â”‚ 42  â”‚...â”‚  â”‚
â”‚  â”‚ 2  â”‚ api.test.com â”‚ wss://api.test.com   â”‚ closed â”‚ 156 â”‚...â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â–²                                            â”‚
â”‚                          â”‚ SeleÃ§Ã£o                                   â”‚
â”‚                          â”‚                                            â”‚
â”‚  â”Œâ”€ Mensagens â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ Timestamp    â”‚ DireÃ§Ã£o           â”‚ Tamanho â”‚ Tipo          â”‚   â”‚
â”‚  â”‚ 14:23:45.123 â”‚ Clienteâ†’Servidor  â”‚ 15 B    â”‚ Texto         â”‚   â”‚
â”‚  â”‚ 14:23:45.456 â”‚ Servidorâ†’Cliente  â”‚ 234 B   â”‚ Texto         â”‚   â”‚
â”‚  â”‚ 14:23:46.789 â”‚ Clienteâ†’Servidor  â”‚ 512 B   â”‚ BinÃ¡rio       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                          â–²                                            â”‚
â”‚                          â”‚ SeleÃ§Ã£o                                   â”‚
â”‚                          â”‚                                            â”‚
â”‚  â”Œâ”€ ConteÃºdo da Mensagem â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚ {"type":"message","data":"Hello World"}                       â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â”‚                                                                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                                       â”‚
â”‚  [Atualizar] [Limpar HistÃ³rico] [Reenviar] (desabilitado)           â”‚
â”‚                                                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Eventos WebSocket

### 1. websocket_start
Chamado quando uma conexÃ£o WebSocket Ã© estabelecida.

**AÃ§Ãµes:**
- Cria entrada no histÃ³rico de conexÃµes
- Registra URL, host e timestamp
- Define status como 'active'

### 2. websocket_message
Chamado para cada mensagem WebSocket (clienteâ†’servidor ou servidorâ†’cliente).

**AÃ§Ãµes:**
- Identifica direÃ§Ã£o da mensagem
- Detecta se Ã© texto ou binÃ¡rio
- Armazena conteÃºdo e metadata
- Incrementa contador de mensagens

### 3. websocket_end
Chamado quando a conexÃ£o WebSocket Ã© fechada.

**AÃ§Ãµes:**
- Atualiza status para 'closed'
- Registra timestamp de fechamento
- MantÃ©m histÃ³rico de mensagens

## Tipos de Mensagens

### Mensagens de Texto
- Codificadas em UTF-8
- Exibidas como string
- Exemplo: `{"type":"ping"}`

### Mensagens BinÃ¡rias
- NÃ£o sÃ£o UTF-8 vÃ¡lido ou contÃªm bytes nÃ£o-imprimÃ­veis
- Exibidas em formato hexadecimal
- Exemplo: `00010203fffefd`

## LimitaÃ§Ãµes Atuais

### âœ… Implementado
- [x] InterceptaÃ§Ã£o de conexÃµes
- [x] Captura de mensagens
- [x] VisualizaÃ§Ã£o de histÃ³rico
- [x] Suporte a texto e binÃ¡rio
- [x] Interface grÃ¡fica

### âš ï¸ Futuro
- [ ] ModificaÃ§Ã£o de mensagens em tempo real
- [ ] Reenvio de mensagens
- [ ] Filtros avanÃ§ados
- [ ] ExportaÃ§Ã£o de histÃ³rico
- [ ] Busca em mensagens

## IntegraÃ§Ã£o com mitmproxy

O InteceptProxy utiliza os eventos WebSocket do mitmproxy:

```python
class InterceptAddon:
    def websocket_start(self, flow: websocket.WebSocketFlow):
        # Captura inÃ­cio da conexÃ£o
        pass
    
    def websocket_message(self, flow: websocket.WebSocketFlow):
        # Captura cada mensagem
        pass
    
    def websocket_end(self, flow: websocket.WebSocketFlow):
        # Captura fechamento da conexÃ£o
        pass
```

Esses eventos sÃ£o automaticamente chamados pelo mitmproxy quando ele intercepta
trÃ¡fego WebSocket atravÃ©s do proxy.
